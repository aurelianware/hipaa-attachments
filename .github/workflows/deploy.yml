- name: Deploy infrastructure (Bicep)
  shell: bash
  run: |
    set -euo pipefail
    set -x

    # Sanity: make sure the template exists
    ls -la infra
    test -f infra/main.bicep

    # Compile to ARM JSON (catches syntax)
    az bicep build --file infra/main.bicep -o /tmp/main.json

    # VALIDATE first â€“ this returns the real ARM error body if anything is wrong
    az deployment group validate \
      --resource-group "$RG_NAME" \
      --template-file infra/main.bicep \
      --parameters location="$LOCATION" baseName="hipaa-logic" connectorLocation="$CONNECTOR_LOCATION" \
      -o jsonc

    # If validate passes, deploy with a unique name
    DEPLOY_NAME="main-$(date +%s)"
    az deployment group create \
      --resource-group "$RG_NAME" \
      --name "$DEPLOY_NAME" \
      --template-file infra/main.bicep \
      --parameters location="$LOCATION" baseName="hipaa-logic" connectorLocation="$CONNECTOR_LOCATION" \
      -o jsonc --only-show-errors

    # Capture outputs for the next step
    LA_NAME=$(az deployment group show -g "$RG_NAME" -n "$DEPLOY_NAME" --query "properties.outputs.logicAppName.value" -o tsv)
    echo "LOGIC_APP_NAME=$LA_NAME" >> $GITHUB_ENV
    echo "Deployment succeeded. Logic App: $LA_NAME"