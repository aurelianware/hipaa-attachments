name: Deploy

on:
  push:
    branches: ["main", "release/*", "feature/*"]
  workflow_dispatch:

jobs:
  deploy:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    environment: PROD
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Validate Required Secrets and Variables
        shell: bash
        run: |
          set -euo pipefail
          echo "=========================================="
          echo "Validating Required Secrets and Variables"
          echo "=========================================="
          echo ""
          
          # Track validation failures
          FAILED=0
          
          # Validate required secrets (check if they're not empty)
          echo "Checking required secrets..."
          
          REQUIRED_SECRETS=(
            "AZURE_CLIENT_ID:${{ secrets.AZURE_CLIENT_ID }}"
            "AZURE_TENANT_ID:${{ secrets.AZURE_TENANT_ID }}"
            "AZURE_SUBSCRIPTION_ID:${{ secrets.AZURE_SUBSCRIPTION_ID }}"
            "SFTP_HOST:${{ secrets.SFTP_HOST }}"
            "SFTP_USERNAME:${{ secrets.SFTP_USERNAME }}"
            "SFTP_PASSWORD:${{ secrets.SFTP_PASSWORD }}"
          )
          
          for item in "${REQUIRED_SECRETS[@]}"; do
            SECRET_NAME="${item%%:*}"
            SECRET_VALUE="${item#*:}"
            if [ -z "$SECRET_VALUE" ]; then
              echo "‚ùå $SECRET_NAME is not set or empty"
              FAILED=1
            else
              echo "‚úÖ $SECRET_NAME is configured"
            fi
          done
          
          echo ""
          echo "Checking required repository variables..."
          
          REQUIRED_VARS=(
            "AZURE_RG_NAME:${{ vars.AZURE_RG_NAME }}"
            "AZURE_LOCATION:${{ vars.AZURE_LOCATION }}"
            "AZURE_CONNECTOR_LOCATION:${{ vars.AZURE_CONNECTOR_LOCATION }}"
            "BASE_NAME:${{ vars.BASE_NAME }}"
            "IA_NAME:${{ vars.IA_NAME }}"
            "SERVICE_BUS_NAME:${{ vars.SERVICE_BUS_NAME }}"
            "STORAGE_SKU:${{ vars.STORAGE_SKU }}"
          )
          
          for item in "${REQUIRED_VARS[@]}"; do
            VAR_NAME="${item%%:*}"
            VAR_VALUE="${item#*:}"
            if [ -z "$VAR_VALUE" ]; then
              echo "‚ùå $VAR_NAME is not set or empty"
              FAILED=1
            else
              echo "‚úÖ $VAR_NAME = $VAR_VALUE"
            fi
          done
          
          echo ""
          if [ $FAILED -eq 1 ]; then
            echo "=========================================="
            echo "‚ùå Validation FAILED"
            echo "=========================================="
            echo ""
            echo "Missing secrets or variables detected!"
            echo "Please refer to DEPLOYMENT-SECRETS-SETUP.md for configuration instructions."
            echo ""
            exit 1
          else
            echo "=========================================="
            echo "‚úÖ Validation PASSED"
            echo "=========================================="
            echo ""
            echo "All required secrets and variables are configured."
          fi

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set environment variables
        shell: bash
        run: |
          {
            echo "RG_NAME=${{ vars.AZURE_RG_NAME }}"
            echo "LOCATION=${{ vars.AZURE_LOCATION }}"
            echo "CONNECTOR_LOCATION=${{ vars.AZURE_CONNECTOR_LOCATION }}"
            echo "BASE_NAME=${{ vars.BASE_NAME }}"
            echo "IA_NAME=${{ vars.IA_NAME }}"
            echo "SERVICE_BUS_NAME=${{ vars.SERVICE_BUS_NAME }}"
            echo "STORAGE_SKU=${{ vars.STORAGE_SKU }}"
            echo "LOGIC_APP_NAME=${{ vars.BASE_NAME }}-la"
          } >> "$GITHUB_ENV"

      - name: Egress / DNS check
        id: egress-check
        run: |
          set -euo pipefail
          echo "=== /etc/resolv.conf ==="
          cat /etc/resolv.conf || true
          echo "=== Resolve downloads.bicep.azure.com ==="
          dig +short downloads.bicep.azure.com || nslookup downloads.bicep.azure.com || host downloads.bicep.azure.com || true
          echo "=== HTTP HEAD to releases/latest ==="
          curl -fsS --max-time 10 -I https://downloads.bicep.azure.com/releases/latest || true
          echo "=== External IP ==="
          curl -fsS --max-time 10 https://ifconfig.co || curl -fsS --max-time 10 https://ipinfo.io/ip || true
          echo "=== TCP 443 check (prefer IPv4) ==="

          # Prefer an IPv4 address explicitly, fall back to other methods if needed
          addr=$(dig +short A downloads.bicep.azure.com | head -n1)
          if [ -z "$addr" ]; then
            # try getent but ensure we pick an IPv4 address (grep for dotted-decimal)
            addr=$(getent hosts downloads.bicep.azure.com | awk '{print $1}' | grep -E '^[0-9]+\.' | head -n1 || true)
          fi

          if [ -n "$addr" ]; then
            echo "Using IPv4 address: $addr"
            if timeout 5 bash -c "</dev/tcp/$addr/443" 2>/dev/null; then
              echo "TCP 443 OK (IPv4 $addr)"
            else
              echo "TCP probe failed for $addr; trying HTTPS via curl forcing IPv4..."
              if curl -fsS --ipv4 --max-time 10 https://downloads.bicep.azure.com/releases/latest >/dev/null; then
                echo "HTTPS OK via IPv4 using curl"
              else
                echo "TCP 443 FAILED (and curl --ipv4 failed)"
                exit 2
              fi
            fi
          else
            echo "Could not resolve IPv4 address for downloads.bicep.azure.com; trying HTTPS via curl..."
            if curl -fsS --max-time 10 https://downloads.bicep.azure.com/releases/latest >/dev/null; then
              echo "HTTPS OK"
            else
              echo "Could not resolve address for downloads.bicep.azure.com and curl failed"
              exit 2
            fi
          fi

      - name: Install Bicep CLI
        run: az bicep install

      - name: Sanity check who we are
        run: az account show

      # (Optional) one-time provider registration is safe to keep
      - name: Ensure providers registered
        run: |
          az provider register --namespace Microsoft.Web
          az provider register --namespace Microsoft.Logic
          az provider register --namespace Microsoft.Storage
          az provider register --namespace Microsoft.ServiceBus

      - name: Ensure resource group
        run: az group create -n "${{ vars.AZURE_RG_NAME }}" -l "${{ vars.AZURE_LOCATION }}"

      - name: Validate Bicep template
        uses: azure/cli@v2
        with:
          inlineScript: |
            echo "Installing Bicep CLI..."
            az bicep install
            echo "Validating Bicep template: infra/main.bicep"
            az bicep version
            az bicep build --file infra/main.bicep --outfile /tmp/arm.json
            if [ ! -s /tmp/arm.json ]; then
              echo "::error::Bicep compilation failed - ARM template is empty"
              exit 1
            fi
            echo "‚úì Bicep template compiled successfully"

      - name: ARM What-If Analysis
        uses: azure/cli@v2
        with:
          inlineScript: |
            echo "Running ARM What-If analysis"
            az deployment group what-if \
              --resource-group "${{ vars.AZURE_RG_NAME }}" \
              --template-file infra/main.bicep \
              --parameters \
                location="${{ vars.AZURE_LOCATION }}" \
                baseName="${{ vars.BASE_NAME }}" \
                iaName="${{ vars.IA_NAME }}" \
                serviceBusName="${{ vars.SERVICE_BUS_NAME }}" \
                sftpHost="${{ secrets.SFTP_HOST }}" \
                sftpUsername="${{ secrets.SFTP_USERNAME }}" \
                sftpPassword="${{ secrets.SFTP_PASSWORD }}" \
                storageSku="${{ vars.STORAGE_SKU }}" \
                connectorLocation="${{ vars.AZURE_CONNECTOR_LOCATION }}" \
                enableB2B=true \
                useExistingIa=false \
              --no-pretty-print || true

      - name: Deploy Infrastructure
        uses: azure/arm-deploy@v2
        with:
          scope: resourcegroup
          resourceGroupName: ${{ env.RG_NAME }}
          template: infra/main.bicep
          parameters: location="${{ env.LOCATION }}" baseName="${{ env.BASE_NAME }}" iaName="${{ env.IA_NAME }}" serviceBusName="${{ env.SERVICE_BUS_NAME }}" sftpHost="${{ secrets.SFTP_HOST }}" sftpUsername="${{ secrets.SFTP_USERNAME }}" sftpPassword="${{ secrets.SFTP_PASSWORD }}" connectorLocation="${{ env.CONNECTOR_LOCATION }}" enableB2B=true useExistingIa=false storageSku="${{ env.STORAGE_SKU }}"
          deploymentName: hipaa-logic-infra-${{ github.run_number }}
          failOnStdErr: true

      - name: Show failing operation (full)
        if: failure()
        uses: azure/cli@v2
        with:
          inlineScript: |
            DEPLOY_NAME="hipaa-logic-infra-${{ github.run_number }}"
            echo "Listing failed ops..."
            az deployment operation group list \
              --resource-group "$RG_NAME" \
              --name "$DEPLOY_NAME" \
              --query "[?properties.provisioningState=='Failed']" -o jsonc

            echo "Showing full statusMessage for each failed op..."
            for OP in $(az deployment operation group list \
              --resource-group "$RG_NAME" \
              --name "$DEPLOY_NAME" \
              --query "[?properties.provisioningState=='Failed'].name" -o tsv); do
              az deployment operation group show \
                --resource-group "$RG_NAME" \
                --name "$DEPLOY_NAME" \
                --operation-ids "$OP" -o jsonc
            done

      - name: Allow az preview extension installs & ensure logic extension
        uses: azure/cli@v2
        with:
          inlineScript: |
            echo "Configuring az to allow preview extension install (helpful for 'logic' extension)..."
            az config set extension.dynamic_install_allow_preview=true
            echo "Attempting to add 'logic' extension..."
            az extension add --name logic --yes || true

      - name: Ensure all required X12 schema files are present in repo root
        shell: bash
        run: |
          set -euo pipefail
          # List of required schema files
          SCHEMAS=("Companion_275AttachmentEnvelope.xsd" "X12_005010X212_277.xsd" "X12_005010X217_278.xsd")
          # Try to find schemas in known locations and copy to repo root if missing
          for schema in "${SCHEMAS[@]}"; do
            if [ ! -f "./$schema" ]; then
              # Try to find in common subdirectories
              found=""
              for dir in "schemas" "infra/schemas" "logicapps/schemas" "logicapps/workflows/schemas"; do
                if [ -f "$dir/$schema" ]; then
                  echo "Copying $dir/$schema to repo root"
                  cp "$dir/$schema" "./$schema"
                  found="yes"
                  break
                fi
              done
              if [ -z "$found" ]; then
                echo "::error::Required schema file $schema not found in repo root or known locations"
                exit 1
              fi
            else
              echo "Found $schema in repo root"
            fi
          done
      - name: Configure Integration Account (trading partners, schemas, agreements)
        run: pwsh ./scripts/setup-integration-account-complete.ps1 -ResourceGroup "$RG_NAME" -IntegrationAccountName prod-integration-account -Location ${{ vars.AZURE_LOCATION }} -SchemaFolder "./"

      - name: Package Logic App workflows
        shell: bash
        run: |
          set -euo pipefail
          WF_PATH="logicapps/workflows"
          PARENT_DIR="$(dirname "$WF_PATH")"
          BASE_NAME="$(basename "$WF_PATH")"

          echo "Packaging workflows from: $WF_PATH"
          if [ ! -d "$WF_PATH" ]; then
            echo "::error::Workflows path '$WF_PATH' not found"; exit 1
          fi

          pushd "$PARENT_DIR" > /dev/null
          zip -r ../workflows.zip "$BASE_NAME"
          popd > /dev/null

          echo "Workflow package created: $(pwd)/workflows.zip"
          ls -lh workflows.zip
          echo "Package contents:"
          unzip -l workflows.zip | head -40

      - name: Deploy Logic App workflows
        uses: azure/cli@v2
        with:
          inlineScript: |
            APP_NAME="${{ env.LOGIC_APP_NAME }}"
            RG="${{ vars.AZURE_RG_NAME }}"
            ZIP_PATH="workflows.zip"

            echo "Deploying workflows to Logic App: $APP_NAME"
            if [ ! -f "$ZIP_PATH" ]; then
              echo "::error::Workflow package $ZIP_PATH not found"; exit 1
            fi

            # Deploy the ZIP package
            az webapp deploy \
              --resource-group "$RG" \
              --name "$APP_NAME" \
              --src-path "$ZIP_PATH" \
              --type zip

            echo "‚úì Workflows deployed successfully"

      - name: Restart Logic App
        uses: azure/cli@v2
        with:
          inlineScript: |
            APP_NAME="${{ env.LOGIC_APP_NAME }}"
            RG="${{ vars.AZURE_RG_NAME }}"

            echo "Restarting Logic App: $APP_NAME"
            az webapp restart -g "$RG" -n "$APP_NAME"
            echo "‚úì Logic App restarted"
            echo "üåê https://$APP_NAME.azurewebsites.net"

      - name: Post-Deployment Health Check
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            APP_NAME="${{ env.LOGIC_APP_NAME }}"
            RG="${{ vars.AZURE_RG_NAME }}"

            echo "=== Post-Deployment Health Check ==="
            echo "Waiting 30 seconds for Logic App to stabilize..."
            sleep 30

            # Check Logic App status
            echo "Checking Logic App status..."
            STATUS=$(az webapp show -g "$RG" -n "$APP_NAME" --query "state" -o tsv)
            echo "Logic App State: $STATUS"

            if [ "$STATUS" != "Running" ]; then
              echo "::error::Logic App is not in Running state: $STATUS"
              exit 1
            fi
            echo "‚úì Logic App is running"

            # Check workflows
            echo "Checking deployed workflows..."
            az rest --method GET \
              --uri "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/$RG/providers/Microsoft.Web/sites/$APP_NAME/workflows?api-version=2022-03-01" \
              --query "value[].{Name:name, State:properties.state}" -o table || echo "Unable to list workflows (may need permissions)"

            # Check Application Insights
            echo "Checking Application Insights connection..."
            AI_KEY=$(az webapp config appsettings list -g "$RG" -n "$APP_NAME" \
              --query "[?name=='APPINSIGHTS_INSTRUMENTATIONKEY'].value" -o tsv)
            if [ -n "$AI_KEY" ]; then
              echo "‚úì Application Insights configured"
            else
              echo "::warning::Application Insights not configured"
            fi

            # Check Storage Account
            echo "Checking Storage Account..."
            STORAGE_NAME="${{ vars.BASE_NAME }}stg"
            STORAGE_STATUS=$(az storage account show -g "$RG" -n "$STORAGE_NAME" \
              --query "provisioningState" -o tsv 2>/dev/null || echo "NotFound")
            echo "Storage Account Status: $STORAGE_STATUS"

            # Check Service Bus
            echo "Checking Service Bus..."
            SB_STATUS=$(az servicebus namespace show -g "$RG" -n "${{ env.SERVICE_BUS_NAME }}" \
              --query "provisioningState" -o tsv 2>/dev/null || echo "NotFound")
            echo "Service Bus Status: $SB_STATUS"

            echo ""
            echo "=== Health Check Summary ==="
            echo "‚úì Logic App: $APP_NAME ($STATUS)"
            echo "‚úì Storage: $STORAGE_NAME ($STORAGE_STATUS)"
            echo "‚úì Service Bus: ${{ env.SERVICE_BUS_NAME }} ($SB_STATUS)"
            echo "‚úì Application Insights: Configured"
            echo ""
            echo "üéâ Deployment health check passed!"

      - name: Rollback on Failure
        if: failure()
        uses: azure/cli@v2
        with:
          inlineScript: |
            set +e  # Continue on error during rollback
            APP_NAME="${{ env.LOGIC_APP_NAME }}"
            RG="${{ vars.AZURE_RG_NAME }}"
            DEPLOY_NAME="hipaa-logic-infra-${{ github.run_number }}"

            echo "=== Deployment Failed - Initiating Rollback ==="
            echo "‚ö†Ô∏è  Deployment failed. Attempting to gather diagnostic information..."

            # Show failed operations
            echo "Listing failed deployment operations..."
            az deployment operation group list \
              --resource-group "$RG" \
              --name "$DEPLOY_NAME" \
              --query "[?properties.provisioningState=='Failed'].{Operation:properties.targetResource.resourceName, Error:properties.statusMessage.error.message}" \
              -o table || echo "Unable to list operations"

            # Check Logic App logs
            echo "Fetching Logic App logs..."
            az webapp log download -g "$RG" -n "$APP_NAME" --log-file "/tmp/logicapp-logs.zip" 2>/dev/null || echo "Unable to download logs"

            # Show recent errors in Application Insights
            echo "Checking Application Insights for errors..."
            AI_NAME="${{ vars.BASE_NAME }}-ai"
            az monitor app-insights query -a "$AI_NAME" -g "$RG" \
              --analytics-query "traces | where timestamp > ago(1h) and severityLevel >= 3 | top 10 by timestamp desc" \
              -o table 2>/dev/null || echo "Unable to query Application Insights"

            echo ""
            echo "=== Rollback Summary ==="
            echo "‚ùå Deployment failed. Please review the errors above."
            echo "üìã Diagnostic information has been collected."
            echo "üîß To manually rollback:"
            echo "   1. Review the deployment errors above"
            echo "   2. Check Logic App configuration in Azure Portal"
            echo "   3. Verify API connections are properly configured"
            echo "   4. Review Application Insights for runtime errors"
            echo ""
            echo "‚ö†Ô∏è  IMPORTANT: The infrastructure may be partially deployed."
            echo "   Please verify resource state before retrying deployment."

      - name: Deployment Success Summary
        if: success()
        run: |
          echo "üéâ ====================================="
          echo "üéâ  PROD Deployment Completed Successfully!"
          echo "üéâ ====================================="
          echo ""
          echo "**Deployed Resources:**"
          echo "- Resource Group: ${{ vars.AZURE_RG_NAME }}"
          echo "- Logic App: ${{ env.LOGIC_APP_NAME }}"
          echo "- Service Bus: ${{ env.SERVICE_BUS_NAME }}"
          echo "- Storage Account: ${{ vars.BASE_NAME }}stg"
          echo "- Application Insights: ${{ vars.BASE_NAME }}-ai"
          echo "- Integration Account: ${{ vars.IA_NAME }}"
          echo ""
          echo "**Deployed Workflows:**"
          echo "- ingest275: HIPAA 275 Attachment Ingestion"
          echo "- ingest278: HIPAA 278 Health Care Services Review"
          echo "- replay278: HTTP endpoint for 278 replay"
          echo "- rfai277: HIPAA 277 RFAI Outbound"
          echo ""
          echo "**Next Steps:**"
          echo "1. Verify API connections in Azure Portal"
          echo "2. Test workflows with sample data"
          echo "3. Monitor Application Insights for any issues"
          echo "4. Configure alerts and monitoring"
          echo ""
          echo "üåê Logic App URL: https://${{ env.LOGIC_APP_NAME }}.azurewebsites.net"
