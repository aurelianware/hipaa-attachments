name: pr-lint
on:
  pull_request:
    branches: [main, 'release/*', 'feature/*']

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- JSON validation for Logic App workflows ----------
      - name: Validate JSON workflows
        run: |
          echo "Validating Logic App workflow JSON files..."
          failed=0
          while IFS= read -r -d '' f; do
            echo "Checking $f"
            if ! jq . "$f" >/dev/null 2>&1; then
              echo "::error file=$f::Invalid JSON syntax"
              failed=1
            elif ! jq -e 'has("definition") and has("kind") and has("parameters")' "$f" >/dev/null; then
              echo "::error file=$f::Missing required keys (definition/kind/parameters)"
              failed=1
            else
              echo "✓ Valid workflow JSON: $f"
            fi
          done < <(find logicapps/workflows -type f -name "workflow.json" -print0 2>/dev/null || true)

          if [ $failed -eq 1 ]; then
            echo "::error::JSON validation failed"
            exit 1
          fi
          echo "✓ All workflow JSON files are valid"

      # ---------- GitHub Actions workflow lint ----------
      - name: Actionlint (workflows linter)
        uses: reviewdog/action-actionlint@v1
        with:
          actionlint_flags: -color

      # ---------- YAML lint (workflows & configs) ----------
      - name: YAML lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: ".github/workflows"
          config_data: "extends: default\nrules:\n  line-length: false\n  document-start: false\n  truthy: false"
      # ---------- Bicep syntax check (no Azure login) ----------
      - name: Setup Bicep
        run: |
          echo "Installing Bicep CLI..."
          az bicep install
          az bicep version

      - name: Bicep build (syntax validation)
        run: |
          set -euo pipefail
          echo "Validating Bicep templates..."
          failed=0

          if [ -f infra/main.bicep ]; then
            echo "Building infra/main.bicep..."
            if az bicep build --file infra/main.bicep --outfile /tmp/main-arm.json 2>&1 | tee /tmp/bicep-main.log; then
              if [ ! -s /tmp/main-arm.json ]; then
                echo "::error file=infra/main.bicep::Bicep compilation produced empty ARM template"
                failed=1
              else
                SIZE=$(stat -f%z /tmp/main-arm.json 2>/dev/null || stat -c%s /tmp/main-arm.json 2>/dev/null)
                echo "✓ infra/main.bicep compiled successfully (ARM template: ${SIZE} bytes)"
                echo "ARM template preview (first 20 lines):"
                head -20 /tmp/main-arm.json
              fi
            else
              echo "::error file=infra/main.bicep::Bicep build failed"
              cat /tmp/bicep-main.log
              failed=1
            fi
          else
            echo "::warning::infra/main.bicep not found"
          fi

          if [ -f attachments_logicapps_package/main.bicep ]; then
            echo "Building attachments_logicapps_package/main.bicep..."
            if az bicep build --file attachments_logicapps_package/main.bicep --outfile /tmp/package-arm.json 2>&1 | tee /tmp/bicep-package.log; then
              if [ ! -s /tmp/package-arm.json ]; then
                echo "::error file=attachments_logicapps_package/main.bicep::Bicep compilation produced empty ARM template"
                failed=1
              else
                SIZE=$(stat -f%z /tmp/package-arm.json 2>/dev/null || stat -c%s /tmp/package-arm.json 2>/dev/null)
                echo "✓ attachments_logicapps_package/main.bicep compiled successfully (ARM template: ${SIZE} bytes)"
              fi
            else
              echo "::error file=attachments_logicapps_package/main.bicep::Bicep build failed"
              cat /tmp/bicep-package.log
              failed=1
            fi
          fi

          if [ $failed -eq 1 ]; then
            echo "::error::Bicep validation failed - see errors above"
            exit 1
          fi
          echo "✓ All Bicep templates validated successfully"

      - name: Bicep parameter validation
        run: |
          echo "Validating Bicep parameters..."
          if [ -f infra/main.bicep ]; then
            echo "Analyzing required parameters in infra/main.bicep..."
            grep "^param " infra/main.bicep | head -20
            echo "✓ Parameter analysis complete"
          fi

      # ---------- PowerShell script lint ----------
      - name: Install PowerShell Script Analyzer
        shell: pwsh
        run: |
          Write-Host "Installing PSScriptAnalyzer module..."
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -SkipPublisherCheck
          Write-Host "✓ PSScriptAnalyzer installed successfully"

      - name: PowerShell Script Analyzer
        shell: pwsh
        run: |
          Write-Host "Running PSScriptAnalyzer on PowerShell scripts..."
          $scripts = Get-ChildItem -Path . -Filter "*.ps1" -Recurse | Where-Object { $_.FullName -notmatch '[\\/]\.git[\\/]' }
          $failed = $false

          foreach ($script in $scripts) {
            Write-Host "Analyzing: $($script.FullName)"
            $results = Invoke-ScriptAnalyzer -Path $script.FullName -Severity Error

            if ($results) {
              $failed = $true
              foreach ($result in $results) {
                $severity = $result.Severity.ToString().ToLower()
                $message = "$($result.RuleName): $($result.Message)"
                Write-Host "::$severity file=$($script.FullName),line=$($result.Line),col=$($result.Column)::$message"
              }
            } else {
              Write-Host "✓ No issues found in: $($script.Name)"
            }
          }

          if ($failed) {
            Write-Host "::error::PSScriptAnalyzer found issues in one or more scripts"
            exit 1
          }
          Write-Host "✓ All PowerShell scripts passed analysis"

      - name: PowerShell script syntax validation
        run: |
          echo "Validating PowerShell script syntax..."
          if command -v pwsh >/dev/null 2>&1; then
            failed=0
            while IFS= read -r -d '' f; do
              echo "Checking syntax: $f"
              if ! pwsh -Command "Get-Content '$f' | Out-Null" 2>/dev/null; then
                echo "::error file=$f::PowerShell script has syntax errors"
                failed=1
              else
                echo "✓ Valid syntax: $f"
              fi
            done < <(find . -name "*.ps1" -print0 2>/dev/null || true)

            if [ $failed -eq 1 ]; then
              echo "::error::PowerShell syntax validation failed"
              exit 1
            fi
            echo "✓ All PowerShell scripts have valid syntax"
          else
            echo "PowerShell not available, skipping syntax validation"
          fi

      # ---------- EDI file validation ----------
      - name: Validate EDI X12 files
        shell: pwsh
        run: |
          Write-Host "Validating EDI X12 files..."
          if (Test-Path "scripts/validate-edi-x12.ps1") {
            $ediFiles = Get-ChildItem -Filter "*.edi" -File -ErrorAction SilentlyContinue

            if ($ediFiles.Count -eq 0) {
              Write-Host "No EDI files found to validate"
            } else {
              Write-Host "Found $($ediFiles.Count) EDI file(s)"
              $failed = $false

              foreach ($file in $ediFiles) {
                Write-Host "Validating: $($file.Name)"
                & ./scripts/validate-edi-x12.ps1 -Path $file.FullName -Strict

                if ($LASTEXITCODE -ne 0) {
                  $failed = $true
                }
              }

              if ($failed) {
                Write-Host "::error::EDI validation failed"
                exit 1
              }
            }
          } else {
            Write-Host "EDI validation script not found, skipping"
          }
          Write-Host "✓ EDI validation complete"

      # ---------- Security scanning ----------
      - name: Scan for secrets and credentials
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: ${{ github.event.repository.default_branch || 'main' }}
          head: HEAD
          extra_args: --only-verified

      - name: Scan for PII/PHI
        shell: pwsh
        run: |
          Write-Host "Scanning for PII/PHI in code..."
          if (Test-Path "scripts/scan-for-phi-pii.ps1") {
            & ./scripts/scan-for-phi-pii.ps1 -Path . -Exclude ".git","node_modules",".terraform"

            # Exit code 1 means critical issues found
            if ($LASTEXITCODE -eq 1) {
              Write-Host "::error::Critical PII/PHI issues found"
              exit 1
            }
          } else {
            Write-Host "::warning::PII/PHI scan script not found"
          }
          Write-Host "✓ PII/PHI scan complete"

      # ---------- File encoding validation ----------
      - name: Validate file encodings
        run: |
          echo "Validating file encodings..."

          # Check for files with potential encoding issues
          while IFS= read -r -d '' f; do
            # Skip binary files and certain directories
            if [[ "$f" =~ \.(png|jpg|jpeg|gif|pdf|zip|tar|gz|exe|dll|bin)$ ]] || \
               [[ "$f" =~ \.git/ ]] || \
               [[ "$f" =~ node_modules/ ]]; then
              continue
            fi

            # Check for NULL bytes (binary content)
            if grep -q $'\x00' "$f" 2>/dev/null; then
              echo "::warning file=$f::File contains NULL bytes (may be binary)"
              continue
            fi

            # Check for UTF-8 without BOM (recommended)
            if file "$f" | grep -q "UTF-8"; then
              # Check for BOM
              if head -c 3 "$f" | grep -q $'\xef\xbb\xbf'; then
                echo "::notice file=$f::File has UTF-8 BOM (consider removing)"
              fi
            fi
          done < <(find . -type f -print0 2>/dev/null || true)

          echo "✓ File encoding validation complete"

      # ---------- HIPAA compliance pattern checks ----------
      - name: HIPAA compliance validation
        run: |
          echo "Validating HIPAA compliance patterns..."

          # Check for unencrypted HTTP in production code
          while IFS= read -r -d '' f; do
            # Skip markdown and test files
            if [[ "$f" =~ \.(md|txt)$ ]] || [[ "$f" =~ test ]]; then
              continue
            fi

            # Check for HTTP URLs (should be HTTPS in production)
            if grep -q "http://" "$f" 2>/dev/null; then
              if grep "http://" "$f" 2>/dev/null | grep -v "localhost\|127.0.0.1\|example.com" | grep -q .; then
                echo "::warning file=$f::Found HTTP URL (should use HTTPS for production)"
              fi
            fi
          done < <(find . \( -name "*.json" -o -name "*.bicep" -o -name "*.yml" -o -name "*.yaml" \) -print0 2>/dev/null || true)

          # Check for encryption settings in Bicep
          if [ -f "infra/main.bicep" ]; then
            if ! grep -q "encryption" infra/main.bicep; then
              echo "::warning file=infra/main.bicep::No encryption settings found (verify HIPAA compliance)"
            fi
          fi

          echo "✓ HIPAA compliance validation complete"

      # ---------- Site build validation ----------
      - name: Install site dependencies
        run: |
          echo "Installing dependencies for site build..."
          npm install
          echo "✓ Dependencies installed"

      - name: Validate site build
        run: |
          echo "Validating site Markdown to HTML conversion..."

          # Check if there are any Markdown files in site/assets
          if [ -d "site/assets" ] && ls site/assets/*.md >/dev/null 2>&1; then
            echo "Found Markdown files in site/assets"

            # Run the build
            npm run build:site

            if [ $? -ne 0 ]; then
              echo "::error::Site build failed"
              exit 1
            fi

            # Check if assessment.html exists and is in sync
            if [ -f "site/assessment.html" ]; then
              # Compare modification times or check git status
              if git diff --name-only | grep -q "site/assets/cho-assessment.md"; then
                if ! git diff --name-only | grep -q "site/assessment.html"; then
                  echo "::error::assessment.html is out of sync with cho-assessment.md"
                  echo "Please run 'npm run build:site' and commit the generated HTML"
                  exit 1
                fi
              fi

              # Validate HTML structure
              echo "Validating generated HTML structure..."

              # Check for valid HTML (has <!DOCTYPE>, <html>, <head>, <body>)
              if ! grep -q "<!DOCTYPE html>" site/assessment.html; then
                echo "::error file=site/assessment.html::Missing DOCTYPE declaration"
                exit 1
              fi

              if ! grep -q "<html" site/assessment.html; then
                echo "::error file=site/assessment.html::Missing <html> tag"
                exit 1
              fi

              # Check for proper heading structure (should have exactly one h1)
              h1_count=$(grep -o "<h1>" site/assessment.html | wc -l)
              if [ "$h1_count" -ne 1 ]; then
                echo "::warning file=site/assessment.html::Found $h1_count <h1> tags (should have exactly 1 for accessibility)"
              fi

              # Check for list structure (li elements should be in ul/ol)
              if grep -q "<li>" site/assessment.html; then
                # Simple check: count <li> and <ul>+<ol>
                li_count=$(grep -o "<li>" site/assessment.html | wc -l)
                ul_count=$(grep -o "<ul>" site/assessment.html | wc -l)
                ol_count=$(grep -o "<ol>" site/assessment.html | wc -l)

                if [ $((ul_count + ol_count)) -eq 0 ] && [ $li_count -gt 0 ]; then
                  echo "::error file=site/assessment.html::Found <li> tags without parent <ul> or <ol>"
                  exit 1
                fi
              fi

              echo "✓ Generated HTML has valid structure"
            fi

            echo "✓ Site build validation complete"
          else
            echo "No Markdown files found in site/assets, skipping site build validation"
          fi
