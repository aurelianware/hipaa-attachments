name: pr-lint
on:
  pull_request:
    branches: [main, 'release/*', 'feature/*']

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- JSON validation for Logic App workflows ----------
      - name: Validate JSON workflows
        run: |
          echo "Validating Logic App workflow JSON files..."
          failed=0
          while IFS= read -r -d '' f; do
            echo "Checking $f"
            if ! jq . "$f" >/dev/null 2>&1; then
              echo "::error file=$f::Invalid JSON syntax"
              failed=1
            elif ! jq -e 'has("definition") and has("kind") and has("parameters")' "$f" >/dev/null; then
              echo "::error file=$f::Missing required keys (definition/kind/parameters)"
              failed=1
            else
              echo "✓ Valid workflow JSON: $f"
            fi
          done < <(find logicapps/workflows -type f -name "workflow.json" -print0 2>/dev/null || true)

          if [ $failed -eq 1 ]; then
            echo "::error::JSON validation failed"
            exit 1
          fi
          echo "✓ All workflow JSON files are valid"

      # ---------- GitHub Actions workflow lint ----------
      - name: Actionlint (workflows linter)
        uses: reviewdog/action-actionlint@v1
        with:
          actionlint_flags: -color

      # ---------- YAML lint (workflows & configs) ----------
      - name: YAML lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: ".github/workflows"
          config_data: "extends: default\nrules:\n  line-length: false\n  document-start: false\n  truthy: false"
      # ---------- Bicep syntax check (no Azure login) ----------
      - name: Setup Bicep
        run: |
          echo "Installing Bicep CLI..."
          az bicep install
          az bicep version

      - name: Bicep build (syntax validation)
        run: |
          set -euo pipefail
          echo "Validating Bicep templates..."
          failed=0

          if [ -f infra/main.bicep ]; then
            echo "Building infra/main.bicep..."
            if az bicep build --file infra/main.bicep --outfile /tmp/main-arm.json 2>&1 | tee /tmp/bicep-main.log; then
              if [ ! -s /tmp/main-arm.json ]; then
                echo "::error file=infra/main.bicep::Bicep compilation produced empty ARM template"
                failed=1
              else
                SIZE=$(stat -f%z /tmp/main-arm.json 2>/dev/null || stat -c%s /tmp/main-arm.json 2>/dev/null)
                echo "✓ infra/main.bicep compiled successfully (ARM template: ${SIZE} bytes)"
                echo "ARM template preview (first 20 lines):"
                head -20 /tmp/main-arm.json
              fi
            else
              echo "::error file=infra/main.bicep::Bicep build failed"
              cat /tmp/bicep-main.log
              failed=1
            fi
          else
            echo "::warning::infra/main.bicep not found"
          fi

          if [ -f attachments_logicapps_package/main.bicep ]; then
            echo "Building attachments_logicapps_package/main.bicep..."
            if az bicep build --file attachments_logicapps_package/main.bicep --outfile /tmp/package-arm.json 2>&1 | tee /tmp/bicep-package.log; then
              if [ ! -s /tmp/package-arm.json ]; then
                echo "::error file=attachments_logicapps_package/main.bicep::Bicep compilation produced empty ARM template"
                failed=1
              else
                SIZE=$(stat -f%z /tmp/package-arm.json 2>/dev/null || stat -c%s /tmp/package-arm.json 2>/dev/null)
                echo "✓ attachments_logicapps_package/main.bicep compiled successfully (ARM template: ${SIZE} bytes)"
              fi
            else
              echo "::error file=attachments_logicapps_package/main.bicep::Bicep build failed"
              cat /tmp/bicep-package.log
              failed=1
            fi
          fi

          if [ $failed -eq 1 ]; then
            echo "::error::Bicep validation failed - see errors above"
            exit 1
          fi
          echo "✓ All Bicep templates validated successfully"

      - name: Bicep parameter validation
        run: |
          echo "Validating Bicep parameters..."
          if [ -f infra/main.bicep ]; then
            echo "Analyzing required parameters in infra/main.bicep..."
            grep "^param " infra/main.bicep | head -20
            echo "✓ Parameter analysis complete"
          fi

      # ---------- PowerShell script lint ----------
      - name: Install PowerShell Script Analyzer
        shell: pwsh
        run: |
          Write-Host "Installing PSScriptAnalyzer module..."
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -SkipPublisherCheck
          Write-Host "✓ PSScriptAnalyzer installed successfully"

      - name: PowerShell Script Analyzer
        shell: pwsh
        run: |
          Write-Host "Running PSScriptAnalyzer on PowerShell scripts..."
          $scripts = Get-ChildItem -Path . -Filter "*.ps1" -Recurse | Where-Object { $_.FullName -notmatch '[\\/]\.git[\\/]' }
          $failed = $false

          foreach ($script in $scripts) {
            Write-Host "Analyzing: $($script.FullName)"
            $results = Invoke-ScriptAnalyzer -Path $script.FullName -Severity Error,Warning

            if ($results) {
              $failed = $true
              foreach ($result in $results) {
                $severity = $result.Severity.ToString().ToLower()
                $message = "$($result.RuleName): $($result.Message)"
                Write-Host "::$severity file=$($script.FullName),line=$($result.Line),col=$($result.Column)::$message"
              }
            } else {
              Write-Host "✓ No issues found in: $($script.Name)"
            }
          }

          if ($failed) {
            Write-Host "::error::PSScriptAnalyzer found issues in one or more scripts"
            exit 1
          }
          Write-Host "✓ All PowerShell scripts passed analysis"

      - name: PowerShell script syntax validation
        run: |
          echo "Validating PowerShell script syntax..."
          if command -v pwsh >/dev/null 2>&1; then
            failed=0
            while IFS= read -r -d '' f; do
              echo "Checking syntax: $f"
              if ! pwsh -Command "Get-Content '$f' | Out-Null" 2>/dev/null; then
                echo "::error file=$f::PowerShell script has syntax errors"
                failed=1
              else
                echo "✓ Valid syntax: $f"
              fi
            done < <(find . -name "*.ps1" -print0 2>/dev/null || true)

            if [ $failed -eq 1 ]; then
              echo "::error::PowerShell syntax validation failed"
              exit 1
            fi
            echo "✓ All PowerShell scripts have valid syntax"
          else
            echo "PowerShell not available, skipping syntax validation"
          fi
