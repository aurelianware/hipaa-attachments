name: Pre-Approval Security Checks

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (UAT or PROD)'
        required: true
        type: string
    outputs:
      scan-status:
        description: 'Status of security scans'
        value: ${{ jobs.security-checks.outputs.scan-status }}

jobs:
  security-checks:
    runs-on: ubuntu-latest
    outputs:
      scan-status: ${{ steps.summary.outputs.status }}
    steps:
      - uses: actions/checkout@v4

      - name: Security Scan - Secrets Detection
        id: secrets-scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --json --only-verified

      - name: Security Scan - PII/PHI Detection
        id: phi-scan
        shell: pwsh
        run: |
          Write-Host "ðŸ” Scanning for PII/PHI in deployment artifacts..."
          if (Test-Path "scripts/scan-for-phi-pii.ps1") {
            & ./scripts/scan-for-phi-pii.ps1 -Path . -Exclude ".git","node_modules",".terraform"
            if ($LASTEXITCODE -ne 0) {
              Write-Host "::error::PII/PHI detected in code. Deployment blocked."
              exit 1
            }
            Write-Host "âœ“ PII/PHI scan complete - no issues found"
          } else {
            Write-Host "::error::PII/PHI scan script not found at scripts/scan-for-phi-pii.ps1"
            Write-Host "::error::Deployment blocked for HIPAA compliance. The PII/PHI scanner is mandatory."
            exit 1
          }

      - name: Validate Deployment Artifacts
        id: artifacts-check
        run: |
          echo "Validating deployment readiness..."
          
          # Check for required files
          REQUIRED_FILES=("infra/main.bicep" "logicapps/workflows")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -e "$file" ]; then
              echo "::error::Required file/directory missing: $file"
              exit 1
            fi
          done
          
          echo "âœ“ All required deployment artifacts present"

      - name: Pre-Approval Summary
        id: summary
        if: success()
        run: |
          {
            echo "### ðŸ”’ Pre-Approval Security Checks Passed"
            echo ""
            echo "**Security Validations:**"
            echo "- âœ… No secrets or credentials detected (TruffleHog)"
            echo "- âœ… No PII/PHI in code (HIPAA scanner)"
            echo "- âœ… Deployment artifacts validated"
            echo ""
            echo "**Deployment Details:**"
            echo "- Environment: ${{ inputs.environment }}"
            echo "- Branch: \`${{ github.ref_name }}\`"
            echo "- Commit: \`${{ github.sha }}\`"
            echo "- Triggered by: @${{ github.actor }}"
            echo ""
            echo "Ready for ${{ inputs.environment }} approval review. âœ…"
          } >> "$GITHUB_STEP_SUMMARY"
          echo "status=passed" >> "$GITHUB_OUTPUT"
